<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ZIM F&E Kostenkalkulation – Seite 1</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "system-ui", "sans-serif"],
            },
            colors: {
              slate: {
                850: "#0f172a",
              },
            },
            boxShadow: {
              subtle: "0 1px 2px rgba(15, 23, 42, 0.08)",
            },
          },
        },
      };
    </script>
    <style>
      body {
        font-family: "Inter", system-ui, sans-serif;
        background-color: #f8fafc;
      }

      .gantt-grid {
        display: grid;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel" data-presets="typescript,react">
      const { useMemo, useState, useEffect } = React;

      const MAX_WP = 20;
      const MAX_SUB = 20;
      const MAX_DURATION = 60;
      const MAX_EMPLOYEES = 10;
      const YEAR_CAP_PM = 10.5;
      const STORAGE_KEY = "zim-fe-kostenkalkulation-v3";

      const monthNames = [
        "Jan",
        "Feb",
        "Mär",
        "Apr",
        "Mai",
        "Jun",
        "Jul",
        "Aug",
        "Sep",
        "Okt",
        "Nov",
        "Dez",
      ];

      const DATA_ARBEITSPAKETE = [
        {
          nr: "1",
          bezeichnung:
            "Grundlegende Definition der Anforderungen an den Gärautomaten und das Arbeitsfluid inklusive der Auslegung geeigneter Kristallisationskeime.",
          pm_ungermann: "",
        },
        {
          nr: "1.1",
          bezeichnung:
            "Analyse des zeitabhängigen thermischen Lastprofils des Gärautomaten für die Betriebsmodi Heizen, Kühlen und Schnell- /Schockfrosten sowie Erstellung eines Lasten- und Pflichtenheftes auf Basis der resultierenden Kälte- und Wärmeanforderungen.",
          pm_ungermann: "0,5",
        },
        {
          nr: "1.2",
          bezeichnung:
            "Grobe Dimensionierung der drei Speicherbehälter (zwei Eisbreispeicher und ein Warmsolespeicher) für die Temperaturniveaus −10 °C, −25 °C und 30 °C einschließlich der erforderlichen Wärmedämmung. Ableitung der benötigten Kälteleistung - aus dem zeitabhängigen Lastprofil unter Berücksichtigung der geometrischen Randbedingungen des Kühlraums (ca. 2 × 2 m) für die Versorgung von bis zu zwei Stikkenwagen mit typischen Endprodukten.",
          pm_ungermann: "",
        },
        {
          nr: "1.3",
          bezeichnung:
            "Auslegung des Arbeitsfluids durch Analyse geeigneter Fluidkombinationen (z. B. Wasser/Ethanol) hinsichtlich ihrer Phasendiagramme für den Temperaturbereich von −25 bis +30 °C sowie Bewertung rheologischer, thermophysikalischer und sicherheitsrelevanter Eigenschaften, einschließlich Lebensmittelverträglichkeit, Viskosität, Wärmeübertragungsvermögen und Entflammbarkeit.",
          pm_ungermann: "",
        },
        {
          nr: "1.4",
          bezeichnung:
            "Auslegung geeigneter Partikel als gezielte Kristallisationskeime im Arbeitsfluid unter Berücksichtigung ihrer Dichte, Oberflächenchemie zur Förderung heterogener Nukleation, chemischen Beständigkeit, Lebensmittelverträglichkeit sowie ihres Einflusses auf das viskose Strömungsverhalten.",
          pm_ungermann: "",
        },
        {
          nr: "2",
          bezeichnung:
            "Stationäre und dynamische Simulation der einzelnen Kältekreisläufe sowie des Gesamtsystems in Engineering Equation Solver oder Python einschließlich der Optimierung von Anlagen- und Betriebsparametern.",
          pm_ungermann: "",
        },
        {
          nr: "2.1",
          bezeichnung:
            "Festlegung der Betriebsfälle und Modellgrenzen in Engineering Equation Solver (EES) oder Python durch eindeutige Definition der drei Teilsysteme (Primärkältekreis, Unterkühlungs-/Kristallisationskreis, Speicher-/Verbraucherkreis) und deren Darstellung in einem Blockdiagramm sowie einer vollständigen Variablenliste.",
          pm_ungermann: "",
        },
        {
          nr: "2.2",
          bezeichnung:
            "Erstellung einer Stoffdatenbasis für Kältemittel, Sole und Eisbrei unter Nutzung von EES-Property-Funktionen oder validierten Literaturdaten sowie Definition eines Enthalpiemodells für Eisbrei mit expliziter Berücksichtigung der latenten Schmelzenthalpie.",
          pm_ungermann: "",
        },
        {
          nr: "2.3",
          bezeichnung:
            "Stationäre Modellierung des Primärkältekreises durch Formulierung der thermodynamischen Gleichungen für Verdichter, Verflüssiger, Expansionsorgan und Verdampfer sowie Berechnung der resultierenden Leistungs- und Exergiegrößen.",
          pm_ungermann: "",
        },
        {
          nr: "2.4",
          bezeichnung:
            "Stationäre Modellierung des Unterkühlungs- und Kristallisationskreises durch Abbildung der beiden Varianten (Kristallisationsverdampfer oder Verdampfer mit separatem Kristallisator), Entwicklung eines Kristallisationsmodells zur Berechnung von Unterkühlungsenthalpie, Eismassenanteil und Fluidtemperatur sowie thermische Kopplung an den Primärkältekreis.",
          pm_ungermann: "",
        },
        {
          nr: "2.5",
          bezeichnung:
            "Dynamische Simulation der Wärme- und Kältespeicher durch Formulierung einer zeitdiskreten Energiebilanz unter Berücksichtigung von Lade- und Entladeleistungen sowie Wärmeverlusten und Berechnung der zeitlichen Entwicklung von Temperatur und Eiskonzentration.",
          pm_ungermann: "",
        },
        {
          nr: "2.6",
          bezeichnung:
            "Stationäre Modellierung des Verbraucherkreislaufs durch Abbildung der Wärmeübertrager mittels UA-Ansätzen und Berechnung der momentanen Kälteleistung in Abhängigkeit der Zu- und Rücklauftemperaturen des Eisbreis.",
          pm_ungermann: "",
        },
        {
          nr: "2.7",
          bezeichnung:
            "Zusammenführung aller zuvor modellierten Teilsysteme zu einer zeitabhängigen Gesamtsimulation auf Basis eines numerischen Zeitschrittverfahrens; für jeden Zeitschritt Berechnung der thermischen Leistungsanforderung, des Speicherbetriebszustands, der erforderlichen Verdampfungs- und Kälteleistung, der Betriebsparameter von Supercooler, Kristallisationseinheit und Pumpensystem sowie der Einhaltung aller zulässigen Betriebsgrenzen.",
          pm_ungermann: "",
        },
        {
          nr: "2.8",
          bezeichnung:
            "Nutzung des Gesamtmodells zur Durchführung parametrischer Studien zur Anlagenoptimierung durch systematische Variation zentraler Auslegungsparameter (Speichergröße, maximal zulässige Eiskonzentration, Verdichterleistung, Wärmeübertrager-UA des Supercoolers, Unterkühlungsgrad) und Bewertung der resultierenden Energiebedarfe, COP-Werte, Temperatur- und Druckgrenzen sowie der Betriebsstabilität.",
          pm_ungermann: "",
        },
        {
          nr: "3",
          bezeichnung:
            "Thermodynamische und strömungsmechanische Untersuchung der Nukleation und Eisbildung im Arbeitsfluid.",
          pm_ungermann: "",
        },
        {
          nr: "3.1",
          bezeichnung:
            "Erstellung eines thermodynamisch-energetischen Basismodells für die Nukleation und Eisbildung durch Definition von Fluidtemperatur, Gefrierpunkt, Unterkühlungsgrad und Mischenthalpie aus Flüssig- und Eisphase sowie Berücksichtigung spezifischer Wärmekapazitäten und latenter Schmelzenthalpie.",
          pm_ungermann: "",
        },
        {
          nr: "3.2",
          bezeichnung:
            "Erweiterung des Basismodells um stoffliche, oberflächenbezogene und geometrische Einflussgrößen des realen Arbeitsfluids, einschließlich thermophysikalischer Stoffdaten, Oberflächeneigenschaften des Kristallisationsverdampfers bzw. Kristallisators und relevanter Geometrieparameter, sowie Entwicklung separater Modelle für heterogene Volumennukleation und Wandnukleation.",
          pm_ungermann: "",
        },
        {
          nr: "3.3",
          bezeichnung:
            "Kalibrierung und Validierung des Nukleationsmodells durch Abgleich von experimentell bestimmten Unterkühlungsgraden, Eismassenanteilen und Temperaturverläufen mit den Modellvorhersagen und anschließende Anpassung kritischer Modellparameter bis zur Konsistenz zwischen Experiment und Simulation.",
          pm_ungermann: "",
        },
        {
          nr: "3.4",
          bezeichnung:
            "Durchführung einer systematischen Parameterstudie, in der Geometrie- und Oberflächenparameter (Rohrdurchmesser, Krümmungsradien, Einbauten/Drallkörper, Rauigkeit, effektiver Kontaktwinkel, Beschichtungsvarianten) variiert werden, um die optimale Kombination zur Minimierung von Wandnukleation und Maximierung der Volumennukleation zu bestimmen.",
          pm_ungermann: "",
        },
        {
          nr: "3.5",
          bezeichnung:
            "Durchführung von CFD-Simulationen zur Optimierung der Verdampfergeometrie mit dem Ziel, wandnahe Strömungsgeschwindigkeiten und Wandschubspannungen zu maximieren, um Wandvereisung zu unterdrücken und die Ablösung entstehender Eiskristalle zu gewährleisten.",
          pm_ungermann: "",
        },
        {
          nr: "4",
          bezeichnung:
            "Experimentelle Charakterisierung, Validierung und prototypische Umsetzung des Kristallisationsverdampfers im Temperaturbereich von −10 bis −25 °C.",
          pm_ungermann: "",
        },
        {
          nr: "4.1",
          bezeichnung:
            "Charakterisierung des Arbeitsfluids (z. B. Wasser–Ethanol) durch Bestimmung von Viskosität (Kapillarrohr-Viskometer), Dichte, Wärmekapazität, Wärmeleitfähigkeit, Gefrierpunkt und Wärmeübergangskoeffizienten bei variierenden Temperaturen und Eismassenanteilen.",
          pm_ungermann: "",
        },
        {
          nr: "4.2",
          bezeichnung:
            "Experimentelle Untersuchung zuvor simulierter Oberflächenmaterialien hinsichtlich Unterkühlungsstabilität, Nukleationsneigung, Eisadhäsion und Abriebbeständigkeit; Herstellung definierter Platten oder Rohrsegmente mit simulierten Beschichtungen (z. B. PTFE-artige Schichten oder nickelhaltige Metalloberflächen).",
          pm_ungermann: "2",
        },
        {
          nr: "4.3",
          bezeichnung:
            "Bestimmung des Nukleationszeitpunkts durch Eintauchen der Oberflächen in unterkühlte Fluide und Detektion mittels optischer bzw. akustischer Sensorik sowie Analyse der hydrodynamischen Ablösung und Ermittlung der Eisadhäsionsspannung.",
          pm_ungermann: "1,5",
        },
        {
          nr: "4.4",
          bezeichnung:
            "Systematischer Vergleich der Oberflächenvarianten bezüglich Unterkühlungsstabilität, Nukleationsneigung, Adhäsionskraft und Versuchswiederholbarkeit sowie Ableitung von Designregeln zur Minimierung von Wandausfrierung.",
          pm_ungermann: "2,5",
        },
        {
          nr: "4.5",
          bezeichnung:
            "Aufbau des zuvor simulierten Rohrleitungssystems des Kristallisationsverdampfers für experimentelle Untersuchungen zur Abspülbarkeit von Eiskristallen unter realitätsnahen Strömungsbedingungen.",
          pm_ungermann: "2,5",
        },
        {
          nr: "4.6",
          bezeichnung:
            "Variation der Rohrgeometrie in vier definierten Varianten (Coiled Tubes, wellige Rohre, Rohre mit Helixstrukturen, Rohre mit flachen Noppen) zur Erzeugung lokaler Geschwindigkeitsmaxima sowie gezielter Sekundärströmungen und Wirbelstrukturen an der Wand.",
          pm_ungermann: "3",
        },
        {
          nr: "4.7",
          bezeichnung:
            "Aufbau eines transparenten Teststands (Plexiglasrohrsystem) mit Pumpeneinheit, Kältekreislauf, Beleuchtung und Kamerasystem zur Visualisierung von Kristallisation, Wandbedeckung und Ablöseprozessen.",
          pm_ungermann: "3",
        },
        {
          nr: "4.8",
          bezeichnung:
            "Durchführung systematischer Versuchsreihen unter Variation von Geometrie, Strömungsgeschwindigkeit, Temperatur und Keimpartikelkonzentration zur Quantifizierung und Optimierung der hydrodynamischen Kristallabspülung.",
          pm_ungermann: "2,5",
        },
        {
          nr: "4.9",
          bezeichnung:
            "Optische Auswertung der zeitabhängigen Wandbedeckung durch regelmäßige Bildaufnahme, Bestimmung der Zeit bis zur Ausbildung einer geschlossenen Eisbrücke (Blockade) und Auswahl eines optimalen Rohrdesigns.",
          pm_ungermann: "1,5",
        },
        {
          nr: "4.10",
          bezeichnung:
            "Fertigung eines Prototyps des Kristallisationsverdampfers mit der identifizierten optimalen Rohrgeometrie und Oberflächenbeschichtung sowie Wiederholung der Blockadetests zur quantitativen Bewertung der Betriebsstabilität.",
          pm_ungermann: "3",
        },
        {
          nr: "5",
          bezeichnung:
            "Experimentelle Entwicklung und Validierung eines Supercoolers und eines Kristallisators für den Temperaturbereich von −2 bis −5 °C.",
          pm_ungermann: "",
        },
        {
          nr: "5.1",
          bezeichnung:
            "Erneute experimentelle Untersuchung und Optimierung der Oberflächenbeschichtungen unter angepasster Fluidzusammensetzung durch Herstellung definierter Probekörper, Eintauchen in unterkühlte Fluide sowie Bestimmung von Nukleationszeitpunkt und Eisadhäsionsspannung, um die leistungsfähigsten Oberflächenvarianten zu identifizieren.",
          pm_ungermann: "",
        },
        {
          nr: "5.2",
          bezeichnung:
            "Aufbau eines Verdampfers (Supercoolers) mit nicht optimierter Rohrgeometrie, ausgestattet mit den zuvor identifizierten Beschichtungsvarianten, und experimentelle Bestimmung des maximal stabilen Unterkühlungsgrades bis zur Erstkristallisation zur Auswahl eines finalen, unterkühlungsstabilen Beschichtungssystems.",
          pm_ungermann: "",
        },
        {
          nr: "5.3",
          bezeichnung:
            "Entwicklung und Validierung eines Nukleators mit homogenisierter Strömungsführung und beschichteten Kontaktoberflächen sowie Implementierung aktiver Triggermechanismen (Ultraschall, Peltier-Element). Durchführung systematischer Vergleichsversuche zur Bestimmung der Kristallisationsauslösezeit, der Reproduzierbarkeit und der Robustheit gegenüber thermischen und hydraulischen Störgrößen zur Auswahl des optimalen Auslöseverfahrens.",
          pm_ungermann: "",
        },
        {
          nr: "5.4",
          bezeichnung:
            "Auslegung und experimentelle Prüfung eines thermischen Schutzsystems zur Verhinderung des Eindringens der Kristallisationsfront in den Supercooler durch Integration beheizbarer Rohrabschnitte, Nutzung des temperierten Kältemittels aus dem Verflüssiger sowie Entwicklung eines dazugehörigen Bypass- und Regelkonzeptes zur definierten thermischen Stabilisierung der Grenzbereiche.",
          pm_ungermann: "",
        },
        {
          nr: "5.5",
          bezeichnung:
            "Entwicklung eines präzisen Temperaturregelkonzepts für den Supercooler durch Aufbau einer kaskadierten Regelstruktur, bei der der innere Regler das elektronische Expansionsventil (EEV) steuert und der äußere Regler die Austrittstemperatur des Arbeitsfluids stabil im zulässigen Unterkühlungsbereich hält.",
          pm_ungermann: "2,5",
        },
        {
          nr: "5.6",
          bezeichnung:
            "Experimentelle Untersuchung des Gesamtsystems aus Supercooler und Kristallisator durch Variation von Unterkühlungsgrad, Massenstrom und Triggermechanismus, Messung der stabil erreichbaren Unterkühlung im Supercooler, Erfassung der zeitlichen und mengenmäßigen Kristallbildung im Kristallisator sowie Bewertung der Betriebsstabilität hinsichtlich Temperaturführung, Eismassenanteil und Wiederholbarkeit.",
          pm_ungermann: "",
        },
        {
          nr: "6",
          bezeichnung:
            "Entwicklung eines Systems zur Steuerung der Eisbreikonzentration sowie Auslegung von Peripheriekomponenten.",
          pm_ungermann: "",
        },
        {
          nr: "6.1",
          bezeichnung:
            "Entwicklung eines variablen Rührwerks im Eisbreispeicher, bei dem Höhe und Betriebsparameter gezielt angepasst werden, um eine stabile Eiskonzentration von 20–25 % an den Verbrauchern bereitzustellen.",
          pm_ungermann: "2",
        },
        {
          nr: "6.2",
          bezeichnung:
            "Entwicklung einer Methode zur Bestimmung des Eisanteils über Temperaturmessung oder dichtebasierte Sensorik (z. B. Coriolis), unter Berücksichtigung des Dichteunterschieds zwischen Flüssigphase und Eis.",
          pm_ungermann: "2",
        },
        {
          nr: "6.3",
          bezeichnung:
            "Erarbeitung einer Steuer- und Regelstrategie für ein höhenverstellbares, drehzahlgeregeltes Rührwerk, einschließlich Definition geeigneter Betriebsmodi (z. B. Intervallbetrieb, partielles Rühren im unteren Tankbereich).",
          pm_ungermann: "1,5",
        },
        {
          nr: "6.4",
          bezeichnung:
            "Durchführung systematischer Versuchsreihen zur Untersuchung des Einflusses von Rührhöhe, Drehzahl und Einschaltdauer auf erreichbare Eiskonzentration und elektrischen Energiebedarf sowie Ableitung einer optimalen Regel- und Steuerstrategie.",
          pm_ungermann: "1,5",
        },
        {
          nr: "6.5",
          bezeichnung:
            "Identifikation geeigneter Pumpentypen für hochviskose, kalte und partikelhaltige Fluide sowie Durchführung von Dauerversuchen zur Bewertung von Förderleistung, Druckverlust, Vereisungsanfälligkeit und Verschleißverhalten bei −25 °C und variierenden Eiskonzentrationen und Keimpartikelanteilen.",
          pm_ungermann: "1",
        },
        {
          nr: "6.6",
          bezeichnung:
            "Entwicklung eines Wärmeübertragers auf der Verbraucherseite, der eine störungsfreie Durchströmung von Eispartikeln ermöglicht, durch Anpassung von Kanal- und Rohrdurchmessern, Minimierung enger Umlenkungen sowie Auswahl geeigneter, abrasionsbeständiger Materialien und Oberflächen.",
          pm_ungermann: "2",
        },
        {
          nr: "6.7",
          bezeichnung:
            "Entwicklung eines Systems zur aktiven Anpassung der Fluidzusammensetzung (z. B. Wasser–Ethanol), um über die konzentrationsabhängige Gefrierpunktkurve unterschiedliche Eisbreitemperaturen gezielt einstellen zu können.",
          pm_ungermann: "2,5",
        },
        {
          nr: "6.8",
          bezeichnung:
            "Aufbau der Hardware zur automatisierten Konzentrationsanpassung, bestehend aus Osmoseeinheit zur Wasserabtrennung, zwei Pufferbehältern (konzentrierte Lösung und Reinstwasser), Dosier- und Mischpumpe sowie Inline-Sensorik (Dichte bzw. Refraktometrie und Temperatur) zur kontinuierlichen Konzentrationsbestimmung.",
          pm_ungermann: "3",
        },
        {
          nr: "6.9",
          bezeichnung:
            "Entwicklung einer Steuerlogik zur Einstellung des Soll-Gefrierpunkts bzw. der Soll-Konzentration (Modus −10 °C oder −25 °C) mittels Rückführung der Inline-Sensorik und Erprobung des Gesamtsystems im Betrieb.",
          pm_ungermann: "1,5",
        },
        {
          nr: "7",
          bezeichnung:
            "Prototypischer Aufbau des Gärautomaten und Entwicklung einer Smart-Grid-gestützten Fahrplanlogik.",
          pm_ungermann: "",
        },
        {
          nr: "7.1",
          bezeichnung:
            "Aufbau der Primärkältemaschine bestehend aus Verdichter, Verflüssiger, Expansionsventil und der thermischen Kopplung des Verdampfers an den Sekundärkreislauf sowie Integration des Verdampfers in den Prozessfluss des Arbeitsfluids.",
          pm_ungermann: "2",
        },
        {
          nr: "7.2",
          bezeichnung:
            "Einbindung des Verdampfers als Kristallisationsmodul im Sekundärkreislauf, sodass Unterkühlung und Kristallisation im selben Bauteil stattfinden, sowie Montage der Eisbreispeicher mit höhenverstellbarem Rührwerk und Sensorik zur Temperatur- und Konzentrationsmessung.",
          pm_ungermann: "1,5",
        },
        {
          nr: "7.3",
          bezeichnung:
            "Installation des Verbraucherkreises mit Sole-Luft-Wärmeübertragern für den Gärautomaten, wobei Kanalgeometrien und Materialauswahl auf die strömungsmechanischen Anforderungen von Eisbrei und Keimpartikeln ausgelegt werden.",
          pm_ungermann: "1,5",
        },
        {
          nr: "7.4",
          bezeichnung:
            "Aufbau des Rohrnetzes und der Pumpentechnik unter Berücksichtigung der hohen Viskosität, der abrasiven Partikelanteile und der niedrigen Betriebstemperaturen (−25 °C) sowie Integration erforderlicher Absperr-, Umschalt- und Regelventile für den systemweiten Betrieb.",
          pm_ungermann: "1",
        },
        {
          nr: "7.5",
          bezeichnung:
            "Installation der Sensor- und Regelungstechnik durch Positionierung von Temperatur-, Druck- und Konzentrationssensoren an Ein- und Austritt des Verdampfers, in kritischen Rohrabschnitten sowie im Eisbreispeicher zur kontinuierlichen Prozessüberwachung.",
          pm_ungermann: "1",
        },
        {
          nr: "7.6",
          bezeichnung:
            "Entwicklung einer prädiktiven Steuerungslogik zur modellbasierten Ableitung optimaler Lade- und Befüllstrategien für zwei sequentiell zu ladende Eisbreispeicher unter Einbezug externer Prognosesignale (Energiepreise, PV-Ertrag) sowie Formulierung von Entscheidungsregeln zu Füllreihenfolge, Sollfüllständen und teil- bzw. vollbefüllten Betriebsweisen.",
          pm_ungermann: "1,5",
        },
        {
          nr: "7.7",
          bezeichnung:
            "Entwicklung selbstlernender Algorithmen zur automatisierten Analyse historischer Lastprofile der Bäckerei und deren Abgleich mit Erzeugungsprognosen, um zeitoptimal gesteuerte Ladezeitpunkte sowie energieeffiziente Betriebsstrategien für die Speicher abzuleiten.",
          pm_ungermann: "2,5",
        },
        {
          nr: "8",
          bezeichnung:
            "Experimentelle Gesamtvalidierung, Leistungsbewertung und Langzeiterprobung des Systems.",
          pm_ungermann: "",
        },
        {
          nr: "8.1",
          bezeichnung:
            "Inbetriebnahme und Funktionsprüfung durch Erstbefüllung des Systems mit reiner Sole ohne Eisanteil sowie Durchführung von Dichtheits-, Druck- und Durchflusstests und anschließender Kalibrierung aller Messketten für Temperatur, Druck, Volumenstrom und Dichte.",
          pm_ungermann: "0,5",
        },
        {
          nr: "8.2",
          bezeichnung:
            "Parametrierung des Kristallisationsverdampfers durch schrittweise Absenkung der Verdampfungstemperatur zur Identifikation eines stabilen Unterkühlungsfensters ohne Festfrieren und Verifizierung des Selbstreinigungseffekts (Eisablösung) durch Analyse lokaler Druckverluste und Temperaturprofile.",
          pm_ungermann: "1",
        },
        {
          nr: "8.3",
          bezeichnung:
            "Test der Eisbreibereitstellung unter realen Betriebsbedingungen durch Durchführung definierter Gärautomat-Zyklen (Gären, Kühlen, Frosten) und Messung der resultierenden Kälteleistung, Eiskonzentration, Produkt-Temperaturverläufe sowie der Strömungsstabilität im Sekundärkältekreislauf.",
          pm_ungermann: "1",
        },
        {
          nr: "8.4",
          bezeichnung:
            "Energetische und hydraulische Bewertung durch Messung der elektrischen Leistungsaufnahme von Verdichter, Pumpen und Rührwerken in verschiedenen Betriebsmodi sowie quantitativer Erfassung der Druckverluste, Identifikation von Bereichen mit erhöhtem Clogging-Risiko und Bestimmung des COP.",
          pm_ungermann: "1",
        },
        {
          nr: "8.5",
          bezeichnung:
            "Langzeittest über mehrere Wochen zur Untersuchung der Stabilität von Eiskonzentration und Fluidzusammensetzung, der Abrasion und des Verschleißverhaltens von Pumpen und Verdampfer sowie des Auftretens möglicher Clogging-Ereignisse und Ableitung geeigneter Reinigungs- und Wartungsintervalle.",
          pm_ungermann: "1,5",
        },
        {
          nr: "8.6",
          bezeichnung:
            "Validierung des Gesamtsystems durch Vergleich der experimentell ermittelten Eismassenanteile, Temperaturprofile und Druckverluste mit den Simulationsergebnissen, Anpassung wesentlicher Modellparameter wie Wärmeübergangs- und rheologischer Kennwerte und Ableitung finaler Auslegungsrichtlinien für die Serienentwicklung.",
          pm_ungermann: "2,5",
        },
      ];

      const COMPANY1_PRESET = {
        projectStartDate: "2026-06-01",
        durationMonths: 30,
        companyName: "Ungermann GmbH",
        employees: [
          {
            partTimeFactor: 1,
            projectPercent: 75,
            name: "Jörg Ungermann",
            weeklyHours: 40,
            actualHours: 40,
            annualSalary: 84000,
          },
          {
            partTimeFactor: 1,
            projectPercent: 75,
            name: "Kai Ungermann",
            weeklyHours: 40,
            actualHours: 40,
            annualSalary: 62101.12,
          },
          {
            partTimeFactor: 1,
            projectPercent: 100,
            name: "Mohammed Ahmed Turki Al-",
            weeklyHours: 40,
            actualHours: 40,
            annualSalary: 54000,
          },
          {
            partTimeFactor: 1,
            projectPercent: 100,
            name: "Maxim Derr",
            weeklyHours: 40,
            actualHours: 40,
            annualSalary: 51700,
          },
          {
            partTimeFactor: 1,
            projectPercent: 100,
            name: "Thomas Schotte",
            weeklyHours: 40,
            actualHours: 40,
            annualSalary: 46384,
          },
        ],
        workPackageSource: DATA_ARBEITSPAKETE,
      };

      const COMPANY1_ASSIGNMENTS = [
        { number: "1.1", start: "06.2026", end: "12.2026", employee: "1" },
        { number: "4.2", start: "01.2027", end: "07.2027", employee: "1" },
        { number: "4.3", start: "01.2027", end: "07.2027", employee: "1" },
        { number: "4.4", start: "01.2027", end: "07.2027", employee: "1" },
        { number: "4.5", start: "01.2027", end: "07.2027", employee: "2" },
        { number: "4.6", start: "01.2027", end: "07.2027", employee: "2" },
        { number: "4.7", start: "01.2027", end: "07.2027", employee: "3" },
        { number: "4.8", start: "01.2027", end: "07.2027", employee: "4" },
        { number: "4.9", start: "01.2027", end: "07.2027", employee: "4" },
        { number: "4.10", start: "01.2027", end: "07.2027", employee: "4" },
        { number: "5.5", start: "07.2027", end: "12.2027", employee: "3" },
        { number: "6.1", start: "07.2027", end: "02.2028", employee: "3" },
        { number: "6.2", start: "07.2027", end: "02.2028", employee: "3" },
        { number: "6.3", start: "07.2027", end: "02.2028", employee: "4" },
        { number: "6.4", start: "07.2027", end: "02.2028", employee: "4" },
        { number: "6.5", start: "07.2027", end: "02.2028", employee: "4" },
        { number: "6.6", start: "07.2027", end: "02.2028", employee: "5" },
        { number: "6.7", start: "07.2027", end: "02.2028", employee: "5" },
        { number: "6.8", start: "07.2027", end: "02.2028", employee: "5" },
        { number: "6.9", start: "07.2027", end: "02.2028", employee: "5" },
        { number: "7.1", start: "02.2028", end: "08.2028", employee: "5" },
        { number: "7.2", start: "02.2028", end: "08.2028", employee: "5" },
        { number: "7.3", start: "02.2028", end: "08.2028", employee: "5" },
        { number: "7.4", start: "02.2028", end: "08.2028", employee: "4" },
        { number: "7.5", start: "02.2028", end: "08.2028", employee: "4" },
        { number: "7.6", start: "02.2028", end: "08.2028", employee: "4" },
        { number: "7.7", start: "02.2028", end: "08.2028", employee: "4" },
        { number: "8.1", start: "07.2028", end: "11.2028", employee: "4" },
        { number: "8.2", start: "07.2028", end: "11.2028", employee: "3" },
        { number: "8.3", start: "07.2028", end: "11.2028", employee: "3" },
        { number: "8.4", start: "07.2028", end: "11.2028", employee: "3" },
        { number: "8.5", start: "07.2028", end: "11.2028", employee: "2" },
        { number: "8.6", start: "07.2028", end: "11.2028", employee: "2" },
      ];

      const COMPANY1_ASSIGNMENT_MAP = COMPANY1_ASSIGNMENTS.reduce((acc, entry) => {
        acc[entry.number] = entry;
        return acc;
      }, {});

      const clampNumber = (value, min, max) => Math.min(max, Math.max(min, value));
      const parseNumber = (value) => {
        if (value === "" || value === null || value === undefined) return 0;
        const parsed = parseFloat(value);
        return Number.isNaN(parsed) ? 0 : parsed;
      };

      const DEFAULT_COMPANY_NAMES = Array.from({ length: 5 }, (_, index) => `Unternehmen ${index + 1}`);
      const DEFAULT_START_DATE = "2026-07-15";
      const DEFAULT_DURATION_MONTHS = 48;

      const createWp = (index) => ({
        id: `wp-${Date.now()}-${index}`,
        title: "",
        pm: Array(5).fill(""),
        sub: [],
      });

      const createSub = (wpIndex, index) => ({
        id: `sub-${Date.now()}-${wpIndex}-${index}`,
        title: "",
        pm: Array(5).fill(""),
      });

      const createCompanyData = () => ({
        zuschlagsfaktorPercent: 0,
        foerderquotePercent: 0,
        maximalbetrag: 0,
        ergebnisse: {
          personalkosten: 0,
          gemeinkostenzuschlag: 0,
          projektsumme: 0,
          foerdersumme: 0,
          verschenkterGesamtbetrag: 0,
        },
        tabellenEintraege: {},
      });

      const createEmployee = () => ({
        partTimeFactor: 1,
        projectPercent: 100,
        name: "",
        weeklyHours: 40,
        actualHours: 40,
        annualSalary: 0,
      });

      const parsePresetPmValue = (value) => {
        if (value === "" || value === null || value === undefined) return "";
        const trimmed = `${value}`.trim();
        if (!trimmed) return "";
        const normalized = trimmed.replace(",", ".");
        const parsed = Number.parseFloat(normalized);
        return Number.isNaN(parsed) ? "" : parsed;
      };

      const buildPresetWorkPackages = (data) => {
        const buildPmRow = (value = "") => [value, "", "", "", ""];
        const result = [];
        let currentWp = null;
        data.forEach((entry, index) => {
          const isHeader = !entry.nr.includes(".");
          if (isHeader) {
            currentWp = {
              id: `wp-preset-${Date.now()}-${index}`,
              title: entry.bezeichnung,
              pm: buildPmRow(""),
              sub: [],
            };
            result.push(currentWp);
            return;
          }
          if (!currentWp) return;
          const pmValue = parsePresetPmValue(entry.pm_ungermann);
          currentWp.sub.push({
            id: `sub-preset-${Date.now()}-${index}`,
            title: entry.bezeichnung,
            pm: buildPmRow(pmValue),
          });
        });
        return result;
      };

      const createDefaultWorkPackages = () => {
        const wp = createWp(0);
        wp.sub = [createSub(0, 0)];
        return [wp];
      };

      const createEmployeesByCompany = () =>
        Array.from({ length: 5 }, () => [createEmployee()]);

      const normalizeCompanyData = (data) => {
        const base = Array.from({ length: 5 }, () => createCompanyData());
        if (!Array.isArray(data)) return base;
        return base.map((fallback, index) => {
          const entry = data[index] || {};
          return {
            ...fallback,
            ...entry,
            ergebnisse: {
              ...fallback.ergebnisse,
              ...(entry.ergebnisse || {}),
            },
            tabellenEintraege: entry.tabellenEintraege || {},
          };
        });
      };

      const parseDate = (value) => {
        const parsed = new Date(value);
        if (Number.isNaN(parsed.getTime())) {
          const fallback = new Date();
          return new Date(fallback.getFullYear(), fallback.getMonth(), 1);
        }
        return new Date(parsed.getFullYear(), parsed.getMonth(), 1);
      };

      const areTableEntriesEqual = (current, next) => {
        const currentKeys = Object.keys(current || {});
        const nextKeys = Object.keys(next || {});
        if (currentKeys.length !== nextKeys.length) return false;
        return currentKeys.every(
          (key) => JSON.stringify(current[key] || {}) === JSON.stringify(next[key] || {})
        );
      };

      const buildTimeline = (startDateValue, duration) => {
        const startDate = parseDate(startDateValue);
        return Array.from({ length: duration }, (_, index) => {
          const date = new Date(startDate.getFullYear(), startDate.getMonth() + index, 1);
          return {
            year: date.getFullYear(),
            month: date.getMonth(),
            label: monthNames[date.getMonth()],
          };
        });
      };

      const groupYears = (timeline) => {
        return timeline.reduce((acc, entry) => {
          const last = acc[acc.length - 1];
          if (!last || last.year !== entry.year) {
            acc.push({ year: entry.year, span: 1 });
          } else {
            last.span += 1;
          }
          return acc;
        }, []);
      };


      const App = () => {
        const [startDate, setStartDate] = useState(DEFAULT_START_DATE);
        const [durationMonths, setDurationMonths] = useState(DEFAULT_DURATION_MONTHS);
        const [companyCount, setCompanyCount] = useState(5);
        const [companyNames, setCompanyNames] = useState(DEFAULT_COMPANY_NAMES);
        const [workPackages, setWorkPackages] = useState(() => createDefaultWorkPackages());
        const [employeesByCompany, setEmployeesByCompany] = useState(() =>
          createEmployeesByCompany()
        );
        const [companyData, setCompanyData] = useState(() => normalizeCompanyData());
        const [pendingDelete, setPendingDelete] = useState(null);
        const [pendingEmployeeDelete, setPendingEmployeeDelete] = useState(null);
        const ganttScrollRef = React.useRef(null);
        const ganttTimelineRef = React.useRef(null);
        const [ganttScrollLeft, setGanttScrollLeft] = useState(0);
        const [ganttMaxScroll, setGanttMaxScroll] = useState(0);
        const [presetNotice, setPresetNotice] = useState("");
        const presetNoticeTimeoutRef = React.useRef(null);
        const [isCompany1PresetApplied, setIsCompany1PresetApplied] = useState(false);
        const [rowHeights, setRowHeights] = useState({});

        useEffect(() => {
          const saved = localStorage.getItem(STORAGE_KEY);
          if (saved) {
            try {
              const parsed = JSON.parse(saved);
              if (parsed?.isCompany1PresetApplied) {
                return;
              }
              if (parsed?.workPackages?.length) {
                setWorkPackages(parsed.workPackages);
              }
              if (parsed?.companyNames?.length) {
                setCompanyNames(parsed.companyNames);
              }
              if (typeof parsed?.companyCount === "number") {
                setCompanyCount(clampNumber(parsed.companyCount, 1, 5));
              } else if (Array.isArray(parsed?.activeCompanies)) {
                const count = parsed.activeCompanies.filter(Boolean).length || 1;
                setCompanyCount(clampNumber(count, 1, 5));
              }
              if (parsed?.startDate) {
                setStartDate(parsed.startDate);
              }
              if (parsed?.durationMonths) {
                setDurationMonths(parsed.durationMonths);
              }
              if (Array.isArray(parsed?.employeesByCompany)) {
                const base = createEmployeesByCompany();
                setEmployeesByCompany(
                  base.map((fallback, index) => {
                    const list = parsed.employeesByCompany[index];
                    return Array.isArray(list) && list.length ? list : fallback;
                  })
                );
              } else if (Array.isArray(parsed?.employees) && parsed.employees.length) {
                const base = createEmployeesByCompany();
                base[0] = parsed.employees;
                setEmployeesByCompany(base);
              }
              if (parsed?.companyData) {
                setCompanyData(normalizeCompanyData(parsed.companyData));
              } else if (parsed?.parameters) {
                const legacy = normalizeCompanyData();
                const next = legacy.map((entry) => ({
                  ...entry,
                  zuschlagsfaktorPercent: parseNumber(parsed.parameters.surchargeFactor),
                  foerderquotePercent: parseNumber(parsed.parameters.fundingRate),
                  maximalbetrag: parseNumber(parsed.parameters.maxAmount),
                }));
                setCompanyData(next);
              }
            } catch (error) {
              console.warn("Lokaler Zustand konnte nicht geladen werden", error);
            }
          }
        }, []);

        useEffect(() => {
          localStorage.setItem(
            STORAGE_KEY,
            JSON.stringify({
              workPackages,
              companyCount,
              companyNames,
              startDate,
              durationMonths,
              employeesByCompany,
              companyData,
              isCompany1PresetApplied,
            })
          );
        }, [
          workPackages,
          companyCount,
          companyNames,
          startDate,
          durationMonths,
          employeesByCompany,
          companyData,
          isCompany1PresetApplied,
        ]);

        useEffect(() => {
          const updateMetrics = () => {
            if (!ganttScrollRef.current) return;
            const { scrollWidth, clientWidth, scrollLeft } = ganttScrollRef.current;
            const maxScroll = Math.max(0, scrollWidth - clientWidth);
            setGanttMaxScroll(maxScroll);
            setGanttScrollLeft(Math.min(scrollLeft, maxScroll));
            if (ganttTimelineRef.current) {
              ganttTimelineRef.current.scrollLeft = scrollLeft;
            }
          };

          updateMetrics();
          window.addEventListener("resize", updateMetrics);
          return () => window.removeEventListener("resize", updateMetrics);
        }, [durationMonths]);

        const activeCompanyIndexes = useMemo(
          () => Array.from({ length: companyCount }, (_, index) => index),
          [companyCount]
        );

        const timeline = useMemo(
          () => buildTimeline(startDate, durationMonths),
          [startDate, durationMonths]
        );
        const yearSegments = useMemo(() => groupYears(timeline), [timeline]);
        const projectYears = useMemo(
          () => Array.from(new Set(timeline.map((entry) => entry.year))),
          [timeline]
        );
        const yearCaps = useMemo(() => {
          const monthsPerYear = timeline.reduce((acc, entry) => {
            acc[entry.year] = (acc[entry.year] || 0) + 1;
            return acc;
          }, {});
          return Object.entries(monthsPerYear).reduce((acc, [year, months]) => {
            acc[year] = (YEAR_CAP_PM * months) / 12;
            return acc;
          }, {});
        }, [timeline]);

        const employeeCostsByCompany = useMemo(() => {
          return employeesByCompany.map((companyEmployees) =>
            companyEmployees.map((employee) => {
              const annualCostBase = parseNumber(employee.annualSalary);
              const typicalHours = parseNumber(employee.weeklyHours);
              const actualHours = parseNumber(employee.actualHours);
              const hourFactor =
                typicalHours > 0 ? actualHours / typicalHours : 1;
              const partTimeFactor = clampNumber(
                parseNumber(employee.partTimeFactor),
                0,
                1
              );
              const projectFactor = clampNumber(
                parseNumber(employee.projectPercent) / 100,
                0,
                1
              );
              const annualProjectCost =
                annualCostBase * hourFactor * partTimeFactor * projectFactor;
              const costPerPM = annualProjectCost / 12;
              return {
                annualProjectCost,
                costPerPM,
              };
            })
          );
        }, [employeesByCompany]);

        const rows = useMemo(() => {
          const list = [];
          workPackages.forEach((wp, wpIndex) => {
            list.push({ type: "wp", wpIndex, subIndex: null });
            wp.sub.forEach((_, subIndex) => {
              list.push({ type: "sub", wpIndex, subIndex });
            });
            list.push({ type: "summary", wpIndex, subIndex: null });
          });
          list.push({ type: "total" });
          return list;
        }, [workPackages]);

        const workPackageRows = useMemo(() => {
          const list = [];
          workPackages.forEach((wp, wpIndex) => {
            list.push({
              id: wp.id,
              number: `${wpIndex + 1}`,
              title: wp.title,
              pmByCompany: wp.pm,
            });
            wp.sub.forEach((sub, subIndex) => {
              list.push({
                id: sub.id,
                number: `${wpIndex + 1}.${subIndex + 1}`,
                title: sub.title,
                pmByCompany: sub.pm,
              });
            });
          });
          return list;
        }, [workPackages]);

        const normalizePmValue = (value) => {
          if (value === "" || value === null || value === undefined) return 0;
          if (typeof value === "number") return value;
          const normalized = `${value}`.trim().replace(",", ".");
          const parsed = Number.parseFloat(normalized);
          return Number.isNaN(parsed) ? 0 : parsed;
        };

        const filteredWorkPackageRowsByCompany = useMemo(() => {
          return activeCompanyIndexes.reduce((acc, companyIndex) => {
            acc[companyIndex] = workPackageRows.filter(
              (row) => normalizePmValue(row.pmByCompany?.[companyIndex]) > 0
            );
            return acc;
          }, {});
        }, [workPackageRows, activeCompanyIndexes]);

        useEffect(() => {
          setCompanyData((prev) => {
            let hasChanges = false;
            const next = prev.map((entry, companyIndex) => {
              if (!activeCompanyIndexes.includes(companyIndex)) {
                return entry;
              }
              const rows = filteredWorkPackageRowsByCompany[companyIndex] || [];
              const existingEntries = entry.tabellenEintraege || {};
              const updatedEntries = rows.reduce((acc, row) => {
                const currentEntry = existingEntries[row.id] || {};
                if (companyIndex === 0 && isCompany1PresetApplied) {
                  const assignment = COMPANY1_ASSIGNMENT_MAP[row.number];
                  acc[row.id] = assignment
                    ? {
                        ...currentEntry,
                        start: assignment.start,
                        ende: assignment.end,
                        mitarbeiterNummer: assignment.employee,
                      }
                    : currentEntry;
                } else {
                  acc[row.id] = currentEntry;
                }
                return acc;
              }, {});

              if (!areTableEntriesEqual(existingEntries, updatedEntries)) {
                hasChanges = true;
                return { ...entry, tabellenEintraege: updatedEntries };
              }
              return entry;
            });
            return hasChanges ? next : prev;
          });
        }, [filteredWorkPackageRowsByCompany, isCompany1PresetApplied, activeCompanyIndexes]);

        const updateWpTitle = (wpIndex, value) => {
          setWorkPackages((prev) => {
            const next = [...prev];
            next[wpIndex] = { ...next[wpIndex], title: value };
            return next;
          });
        };

        const updateSubTitle = (wpIndex, subIndex, value) => {
          setWorkPackages((prev) => {
            const next = [...prev];
            const wp = { ...next[wpIndex] };
            const sub = [...wp.sub];
            sub[subIndex] = { ...sub[subIndex], title: value };
            wp.sub = sub;
            next[wpIndex] = wp;
            return next;
          });
        };

        const updatePm = (wpIndex, subIndex, companyIndex, value) => {
          const numeric = value === "" ? "" : parseNumber(value);
          setWorkPackages((prev) => {
            const next = [...prev];
            if (subIndex === null) {
              const wp = { ...next[wpIndex] };
              const pm = [...wp.pm];
              pm[companyIndex] = numeric;
              wp.pm = pm;
              next[wpIndex] = wp;
            } else {
              const wp = { ...next[wpIndex] };
              const sub = [...wp.sub];
              const subItem = { ...sub[subIndex] };
              const pm = [...subItem.pm];
              pm[companyIndex] = numeric;
              subItem.pm = pm;
              sub[subIndex] = subItem;
              wp.sub = sub;
              next[wpIndex] = wp;
            }
            return next;
          });
        };

        const addWp = () => {
          setWorkPackages((prev) => {
            if (prev.length >= MAX_WP) return prev;
            return [...prev, createWp(prev.length)];
          });
        };

        const addSub = (wpIndex) => {
          setWorkPackages((prev) => {
            const next = [...prev];
            const wp = { ...next[wpIndex] };
            if (wp.sub.length >= MAX_SUB) return prev;
            wp.sub = [...wp.sub, createSub(wpIndex, wp.sub.length)];
            next[wpIndex] = wp;
            return next;
          });
        };

        const requestDelete = (type, wpIndex, subIndex = null) => {
          setPendingDelete({ type, wpIndex, subIndex });
        };

        const cancelDelete = () => setPendingDelete(null);

        const confirmDelete = () => {
          if (!pendingDelete) return;
          const { type, wpIndex, subIndex } = pendingDelete;
          setWorkPackages((prev) => {
            const next = [...prev];
            if (type === "wp") {
              next.splice(wpIndex, 1);
            } else if (type === "sub") {
              const wp = { ...next[wpIndex] };
              const sub = [...wp.sub];
              sub.splice(subIndex, 1);
              wp.sub = sub;
              next[wpIndex] = wp;
            }
            return next.length ? next : createDefaultWorkPackages();
          });
          setPendingDelete(null);
        };

        const addEmployee = (companyIndex) => {
          setEmployeesByCompany((prev) => {
            const next = [...prev];
            const companyEmployees = [...(next[companyIndex] || [])];
            if (companyEmployees.length >= MAX_EMPLOYEES) return prev;
            companyEmployees.push(createEmployee());
            next[companyIndex] = companyEmployees;
            return next;
          });
        };

        const requestEmployeeRemove = (companyIndex) => {
          const companyEmployees = employeesByCompany[companyIndex] || [];
          if (!companyEmployees.length) return;
          setPendingEmployeeDelete(companyIndex);
        };

        const cancelEmployeeRemove = () => setPendingEmployeeDelete(null);

        const confirmEmployeeRemove = () => {
          if (pendingEmployeeDelete === null) return;
          setEmployeesByCompany((prev) => {
            const next = [...prev];
            const companyEmployees = [...(next[pendingEmployeeDelete] || [])];
            companyEmployees.pop();
            next[pendingEmployeeDelete] = companyEmployees.length
              ? companyEmployees
              : [createEmployee()];
            return next;
          });
          setPendingEmployeeDelete(null);
        };

        const updateEmployeeField = (companyIndex, employeeIndex, field, value) => {
          setEmployeesByCompany((prev) => {
            const next = [...prev];
            const companyEmployees = [...(next[companyIndex] || [])];
            companyEmployees[employeeIndex] = {
              ...companyEmployees[employeeIndex],
              [field]: value,
            };
            next[companyIndex] = companyEmployees;
            return next;
          });
        };

        const updateEmployeeNumber = (
          companyIndex,
          employeeIndex,
          field,
          value,
          min,
          max = null
        ) => {
          const numeric = parseNumber(value);
          const clamped = max === null ? Math.max(min, numeric) : clampNumber(numeric, min, max);
          updateEmployeeField(companyIndex, employeeIndex, field, clamped);
        };

        const updateCompanyTableEntry = (companyIndex, rowId, field, value) => {
          setCompanyData((prev) => {
            const next = [...prev];
            const entry = { ...next[companyIndex] };
            const tabellenEintraege = { ...entry.tabellenEintraege };
            const rowEntry = { ...(tabellenEintraege[rowId] || {}) };
            rowEntry[field] = value;
            tabellenEintraege[rowId] = rowEntry;
            entry.tabellenEintraege = tabellenEintraege;
            next[companyIndex] = entry;
            return next;
          });
        };

        const resetToDefaults = () => {
          setStartDate(DEFAULT_START_DATE);
          setDurationMonths(DEFAULT_DURATION_MONTHS);
          setCompanyCount(5);
          setCompanyNames(DEFAULT_COMPANY_NAMES);
          setWorkPackages(createDefaultWorkPackages());
          setEmployeesByCompany(createEmployeesByCompany());
          setCompanyData(normalizeCompanyData());
          setIsCompany1PresetApplied(false);
          setRowHeights({});
        };

        const applyCompany1PresetFromAttachments = () => {
          if (isCompany1PresetApplied) {
            resetToDefaults();
            setPresetNotice("Kontrollzahlen für Ungermann GmbH entfernt");
          } else {
            setStartDate(COMPANY1_PRESET.projectStartDate);
            setDurationMonths(COMPANY1_PRESET.durationMonths);
            setCompanyCount(5);
            setCompanyNames(
              DEFAULT_COMPANY_NAMES.map((name, index) =>
                index === 0 ? COMPANY1_PRESET.companyName : name
              )
            );
            setWorkPackages(buildPresetWorkPackages(COMPANY1_PRESET.workPackageSource));
            setEmployeesByCompany((prev) => {
              const next = [...prev];
              next[0] = COMPANY1_PRESET.employees.map((employee) => ({
                ...createEmployee(),
                ...employee,
              }));
              return next;
            });
            setCompanyData(normalizeCompanyData());
            setIsCompany1PresetApplied(true);
            setPresetNotice("Kontrollzahlen für Ungermann GmbH eingefügt");
          }
          if (presetNoticeTimeoutRef.current) {
            clearTimeout(presetNoticeTimeoutRef.current);
          }
          presetNoticeTimeoutRef.current = setTimeout(() => {
            setPresetNotice("");
          }, 3000);
        };

        const handleGanttScroll = (event) => {
          setGanttScrollLeft(event.currentTarget.scrollLeft);
          if (ganttTimelineRef.current) {
            ganttTimelineRef.current.scrollLeft = event.currentTarget.scrollLeft;
          }
        };

        const handleGanttSliderChange = (event) => {
          const value = parseInt(event.target.value, 10) || 0;
          setGanttScrollLeft(value);
          if (ganttScrollRef.current) {
            ganttScrollRef.current.scrollLeft = value;
          }
          if (ganttTimelineRef.current) {
            ganttTimelineRef.current.scrollLeft = value;
          }
        };

        const sumForCompanies = (pmValues) =>
          activeCompanyIndexes.reduce((acc, idx) => acc + normalizePmValue(pmValues[idx]), 0);

        const sumByCompany = (wp) => {
          return activeCompanyIndexes.map((idx) => {
            const wpValue = normalizePmValue(wp.pm[idx]);
            const subValue = wp.sub.reduce(
              (acc, sub) => acc + normalizePmValue(sub.pm[idx]),
              0
            );
            return wpValue + subValue;
          });
        };

        const totalByCompany = useMemo(() => {
          return activeCompanyIndexes.map((idx) => {
            return workPackages.reduce((acc, wp) => {
              const wpValue = normalizePmValue(wp.pm[idx]);
              const subValue = wp.sub.reduce(
                (inner, sub) => inner + normalizePmValue(sub.pm[idx]),
                0
              );
              return acc + wpValue + subValue;
            }, 0);
          });
        }, [workPackages, activeCompanyIndexes]);

        const totalSum = totalByCompany.reduce((acc, value) => acc + value, 0);

        const leftGridTemplate = useMemo(() => {
          const companyColumns = activeCompanyIndexes.length;
          return `minmax(320px, 1.4fr) repeat(${companyColumns}, minmax(60px, 130px)) minmax(110px, 0.6fr)`;
        }, [activeCompanyIndexes.length]);

        const employeeGridTemplate =
          "minmax(120px, 0.7fr) minmax(150px, 0.9fr) minmax(220px, 1.6fr) minmax(170px, 1.1fr) minmax(170px, 1.1fr) minmax(190px, 1.2fr)";

        const monthGridStyle = useMemo(
          () => ({ gridTemplateColumns: `repeat(${durationMonths}, minmax(32px, 40px))` }),
          [durationMonths]
        );
        const groupAccentClasses = [
          "border-l-sky-300",
          "border-l-indigo-300",
          "border-l-emerald-300",
          "border-l-amber-300",
          "border-l-rose-300",
        ];

        const getRowTone = (row) => {
          if (row.type === "total") return "bg-slate-100/80";
          if (row.type === "summary") return "bg-slate-50";
          if (row.type === "wp") return "bg-slate-100/70";
          if (row.type === "sub") {
            return row.subIndex % 2 === 0 ? "bg-white" : "bg-slate-50/70";
          }
          return "bg-white";
        };

        const getRowHeight = (row) => {
          if (row.type === "header") return "min-h-[120px]";
          return "min-h-[64px]";
        };

        const handleTitleInput = (event, rowKey) => {
          const textarea = event.target;
          textarea.style.height = "auto";
          textarea.style.height = `${textarea.scrollHeight}px`;
          const rowElement = textarea.closest(`[data-row-key="${rowKey}"]`);
          if (rowElement) {
            const height = rowElement.getBoundingClientRect().height;
            setRowHeights((prev) => (prev[rowKey] === height ? prev : { ...prev, [rowKey]: height }));
          }
        };

        useEffect(() => {
          const resizeAll = () => {
            const nodes = document.querySelectorAll("[data-auto-resize='true']");
            nodes.forEach((node) => {
              node.style.height = "auto";
              node.style.height = `${node.scrollHeight}px`;
              const rowKey = node.getAttribute("data-row-key");
              if (!rowKey) return;
              const rowElement = node.closest(`[data-row-key="${rowKey}"]`);
              if (!rowElement) return;
              const height = rowElement.getBoundingClientRect().height;
              setRowHeights((prev) =>
                prev[rowKey] === height ? prev : { ...prev, [rowKey]: height }
              );
            });
          };
          requestAnimationFrame(resizeAll);
        }, [workPackages]);

        const formatCurrency = (value) =>
          new Intl.NumberFormat("de-DE", {
            style: "currency",
            currency: "EUR",
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          }).format(value || 0);

        const projectMonthsByYear = useMemo(() => {
          return timeline.reduce((acc, entry) => {
            acc[entry.year] = (acc[entry.year] || 0) + 1;
            return acc;
          }, {});
        }, [timeline]);

        const usedPmByCompanyEmployeeYear = useMemo(() => {
          return activeCompanyIndexes.reduce((acc, companyIndex) => {
            const companyEmployees = employeesByCompany[companyIndex] || [];
            const used = companyEmployees.map(() => ({}));
            const totalMonths = durationMonths || 1;
            (filteredWorkPackageRowsByCompany[companyIndex] || []).forEach((row) => {
              const pmDemand = row.pmByCompany?.[companyIndex] || 0;
              if (!pmDemand) return;
              const entry = companyData[companyIndex]?.tabellenEintraege?.[row.id] || {};
              const employeeNumber = parseInt(entry.mitarbeiterNummer, 10);
              if (!employeeNumber || employeeNumber < 1) return;
              const employeeIndex = employeeNumber - 1;
              if (!used[employeeIndex]) return;
              const pmPerMonth = pmDemand / totalMonths;
              Object.entries(projectMonthsByYear).forEach(([year, months]) => {
                used[employeeIndex][year] =
                  (used[employeeIndex][year] || 0) + pmPerMonth * months;
              });
            });
            acc[companyIndex] = used;
            return acc;
          }, {});
        }, [
          activeCompanyIndexes,
          employeesByCompany,
          filteredWorkPackageRowsByCompany,
          companyData,
          projectMonthsByYear,
          durationMonths,
        ]);

        return (
          <div className="min-h-screen bg-slate-50 text-slate-900">
            <header className="border-b border-slate-200 bg-white shadow-subtle">
              <div className="mx-auto max-w-[1700px] px-6 py-6">
                <p className="text-sm font-semibold uppercase tracking-[0.2em] text-slate-500">
                  ZIM F&amp;E Kostenkalkulation
                </p>
                <h1 className="mt-2 text-3xl font-semibold text-slate-850">
                  Seite 1: Arbeitspakete / Personenmonate / Zeitplan (Gantt)
                </h1>
                <p className="mt-3 max-w-3xl text-sm text-slate-600">
                  Alle Eingaben stehen in einer durchgehenden Tabellenzeile. Die Zuordnung von
                  Arbeitspaketen, Personenmonaten und Zeitplan bleibt jederzeit visuell eindeutig.
                </p>
              </div>
            </header>

            <main className="mx-auto max-w-[1700px] px-6 py-8">
              <div className="mb-6 grid gap-4 lg:grid-cols-[2.2fr_1.2fr_1fr]">
                <div className="rounded-lg border border-slate-200 bg-white px-4 py-3 shadow-subtle">
                  <div className="flex flex-wrap items-start justify-between gap-4">
                    <div>
                      <div className="text-xs font-semibold uppercase text-slate-500">
                        Unternehmen
                      </div>
                      <label className="mt-3 flex items-center gap-3 text-sm font-medium text-slate-700">
                        Anzahl Unternehmen
                        <input
                          type="number"
                          min="1"
                          max="5"
                          value={companyCount}
                          onChange={(event) =>
                            setCompanyCount(
                              clampNumber(parseInt(event.target.value || "1", 10), 1, 5)
                            )
                          }
                          className="h-9 w-20 rounded-md border border-slate-300 px-2 text-sm focus:border-slate-500 focus:outline-none focus:ring-1 focus:ring-slate-500"
                        />
                      </label>
                    </div>
                    <div className="min-w-[240px] flex-1">
                      <div className="text-xs font-semibold uppercase text-slate-500">
                        Unternehmensnamen
                      </div>
                      <div className="mt-3 grid gap-2 sm:grid-cols-2">
                        {activeCompanyIndexes.map((idx) => (
                          <input
                            key={`company-name-${idx}`}
                            type="text"
                            value={companyNames[idx] || `Unternehmen ${idx + 1}`}
                            onChange={(event) =>
                              setCompanyNames((prev) => {
                                const next = [...prev];
                                next[idx] = event.target.value;
                                return next;
                              })
                            }
                            className="w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-slate-500 focus:outline-none focus:ring-1 focus:ring-slate-500"
                          />
                        ))}
                      </div>
                    </div>
                  </div>

                  <div className="mt-4 flex flex-wrap items-center gap-3">
                    <button
                      type="button"
                      onClick={addWp}
                      disabled={workPackages.length >= MAX_WP}
                      className="inline-flex items-center gap-2 rounded-md bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-subtle transition disabled:cursor-not-allowed disabled:bg-slate-300"
                    >
                      + Arbeitspaket
                    </button>
                    <button
                      type="button"
                      onClick={() => requestDelete("wp", workPackages.length - 1)}
                      disabled={workPackages.length === 0}
                      className="inline-flex items-center gap-2 rounded-md border border-slate-300 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-subtle transition hover:border-slate-400 disabled:cursor-not-allowed disabled:border-slate-200 disabled:text-slate-300"
                    >
                      – Arbeitspaket
                    </button>
                    <button
                      type="button"
                      onClick={applyCompany1PresetFromAttachments}
                      className="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-subtle transition hover:bg-indigo-700"
                      title="Temporäre Entwicklungsfunktion zum Einfügen oder Entfernen von Kontrollzahlen"
                    >
                      {isCompany1PresetApplied
                        ? "Kontrollzahlen für Unternehmen 1 entfernen"
                        : "Kontrollzahlen für Unternehmen 1 einfügen"}
                    </button>
                    {presetNotice && (
                      <span className="text-xs font-semibold text-emerald-600">
                        {presetNotice}
                      </span>
                    )}
                    {pendingDelete?.type === "wp" && (
                      <span className="inline-flex items-center gap-2 text-xs text-rose-600">
                        Wirklich löschen?
                        <button
                          type="button"
                          onClick={confirmDelete}
                          className="rounded border border-rose-200 px-2 py-1 text-rose-700"
                        >
                          Ja
                        </button>
                        <button
                          type="button"
                          onClick={cancelDelete}
                          className="rounded border border-slate-200 px-2 py-1 text-slate-600"
                        >
                          Nein
                        </button>
                      </span>
                    )}
                  </div>
                </div>

                <div className="rounded-lg border border-slate-200 bg-white px-4 py-3 shadow-subtle">
                  <div className="text-xs font-semibold uppercase text-slate-500">
                    Projektstart
                  </div>
                  <input
                    type="date"
                    value={startDate}
                    onChange={(event) => {
                      setStartDate(event.target.value);
                    }}
                    className="mt-2 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-slate-500 focus:outline-none focus:ring-1 focus:ring-slate-500"
                  />
                </div>

                <div className="rounded-lg border border-slate-200 bg-white px-4 py-3 shadow-subtle">
                  <div className="text-xs font-semibold uppercase text-slate-500">
                    Laufzeit (Monate)
                  </div>
                  <input
                    type="number"
                    min="1"
                    max={MAX_DURATION}
                    value={durationMonths}
                    onChange={(event) =>
                      {
                        setDurationMonths(
                          clampNumber(
                            parseInt(event.target.value || "1", 10),
                            1,
                            MAX_DURATION
                          )
                        );
                      }
                    }
                    className="mt-2 w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-slate-500 focus:outline-none focus:ring-1 focus:ring-slate-500"
                  />
                </div>
              </div>

              <div className="mb-3 flex flex-wrap items-end justify-between gap-3">
                <div>
                  <p className="text-xs font-semibold uppercase tracking-[0.18em] text-slate-500">
                    Projektplanung
                  </p>
                  <h2 className="text-xl font-semibold text-slate-850">
                    Projektplanung gesamt
                  </h2>
                </div>
              </div>

              <div className="rounded-xl border border-slate-200 bg-white shadow-subtle">
                <div className="grid lg:grid-cols-[minmax(0,1.2fr)_minmax(0,1fr)]">
                  <div className="border-b border-slate-200 lg:border-b-0 lg:border-r">
                    <div className="sticky top-0 z-30 border-b border-slate-200 bg-slate-100/90 backdrop-blur">
                      <div
                        className={`grid items-stretch ${getRowHeight({ type: "header" })}`}
                        style={{ gridTemplateColumns: leftGridTemplate }}
                      >
                        <div className="px-4 py-4 text-sm font-semibold text-slate-700">
                          Arbeitspaket
                        </div>
                        {activeCompanyIndexes.map((idx) => (
                          <div
                            key={`header-company-${idx}`}
                            className="px-2 py-4 text-xs font-semibold uppercase text-slate-500"
                          >
                            <span
                              className="block max-w-[130px] whitespace-normal break-words leading-tight"
                              title={companyNames[idx] || `Unternehmen ${idx + 1}`}
                            >
                              {companyNames[idx] || `Unternehmen ${idx + 1}`}
                            </span>
                          </div>
                        ))}
                        <div className="px-4 py-4 text-right text-xs font-semibold uppercase text-slate-500">
                          Summe
                        </div>
                      </div>
                    </div>

                    <div className="divide-y divide-slate-100/70">
                      {rows.map((row, rowIndex) => {
                        if (row.type === "total") {
                          return (
                            <div
                              key={`row-total-${rowIndex}`}
                              className={`grid items-center overflow-hidden border-t border-slate-200 ${getRowTone(
                                row
                              )} ${getRowHeight(row)}`}
                              style={{ gridTemplateColumns: leftGridTemplate }}
                            >
                              <div className="px-4 py-2 text-sm font-semibold text-slate-700">
                                Gesamtsumme
                              </div>
                              {totalByCompany.map((value, idx) => (
                                <div
                                  key={`total-company-${idx}`}
                                  className="px-2 py-2 text-sm font-semibold text-slate-700"
                                >
                                  {value.toFixed(2)}
                                </div>
                              ))}
                              <div className="px-4 py-2 text-right text-sm font-semibold text-slate-700">
                                {totalSum.toFixed(2)}
                              </div>
                            </div>
                          );
                        }

                        if (row.type === "summary") {
                          const wp = workPackages[row.wpIndex];
                          const companySums = sumByCompany(wp);
                          const rowSum = companySums.reduce((acc, value) => acc + value, 0);
                          const accent =
                            groupAccentClasses[row.wpIndex % groupAccentClasses.length];
                          return (
                            <div
                              key={`row-summary-${row.wpIndex}`}
                              className={`grid items-center overflow-hidden border-b border-slate-200 ${accent} border-l-4 ${getRowTone(
                                row
                              )} ${getRowHeight(row)} hover:bg-slate-100/70`}
                              style={{ gridTemplateColumns: leftGridTemplate }}
                            >
                              <div className="px-4 py-2 text-sm font-semibold text-slate-600">
                                Summe WP {row.wpIndex + 1}
                              </div>
                              {companySums.map((value, idx) => (
                                <div
                                  key={`summary-company-${row.wpIndex}-${idx}`}
                                  className="px-2 py-2 text-sm font-semibold text-slate-600"
                                >
                                  {value.toFixed(2)}
                                </div>
                              ))}
                              <div className="px-4 py-2 text-right text-sm font-semibold text-slate-700">
                                {rowSum.toFixed(2)}
                              </div>
                            </div>
                          );
                        }

                        const wpIndex = row.wpIndex;
                        const subIndex = row.subIndex;
                        const isWp = row.type === "wp";
                        const wpNumber = wpIndex + 1;
                        const subNumber = subIndex !== null ? `${wpNumber}.${subIndex + 1}` : "";
                        const rowKey = `row-${row.type}-${wpIndex}-${subIndex ?? "root"}`;
                        const title =
                          subIndex === null
                            ? workPackages[wpIndex].title
                            : workPackages[wpIndex].sub[subIndex].title;
                        const values =
                          subIndex === null
                            ? workPackages[wpIndex].pm
                            : workPackages[wpIndex].sub[subIndex].pm;
                        const rowSum = sumForCompanies(values);
                        const isPending =
                          pendingDelete?.wpIndex === wpIndex &&
                          pendingDelete?.type === "sub" &&
                          pendingDelete?.subIndex === workPackages[wpIndex].sub.length - 1;
                        const accent = groupAccentClasses[wpIndex % groupAccentClasses.length];
                        const isGroupStart = row.type === "wp";
                        const groupBorder = isGroupStart
                          ? "border-t border-slate-200"
                          : "border-t border-slate-100/80";

                        return (
                          <div
                            key={`row-${row.type}-${wpIndex}-${subIndex ?? "root"}`}
                            data-row-key={rowKey}
                            className={`grid items-stretch overflow-hidden ${groupBorder} ${accent} border-l-4 ${getRowTone(
                              row
                            )} ${getRowHeight(row)} transition-colors hover:bg-slate-100/70`}
                            style={{ gridTemplateColumns: leftGridTemplate }}
                          >
                            <div className="px-4 py-2">
                              <div className={`flex gap-3 ${isWp ? "" : "pl-4"}`}>
                                <div className="pt-1">
                                  <span
                                    className={`inline-flex min-w-[36px] items-center justify-center rounded-full px-2 py-1 font-mono text-xs font-semibold ${
                                      isWp
                                        ? "bg-slate-900/10 text-slate-700"
                                        : "bg-slate-500/10 text-slate-500"
                                    }`}
                                  >
                                    {isWp ? wpNumber : subNumber}
                                  </span>
                                </div>
                                <div className="flex-1">
                                  <textarea
                                    value={title}
                                    onChange={(event) =>
                                      isWp
                                        ? updateWpTitle(wpIndex, event.target.value)
                                        : updateSubTitle(wpIndex, subIndex, event.target.value)
                                    }
                                    onInput={(event) => handleTitleInput(event, rowKey)}
                                    placeholder={
                                      isWp
                                        ? "Arbeitspaket beschreiben..."
                                        : "Unterarbeitspaket hinzufügen..."
                                    }
                                    rows={1}
                                    data-auto-resize="true"
                                    data-row-key={rowKey}
                                    className={`w-full resize-none rounded-md border border-slate-300 px-3 py-2 text-sm leading-snug focus:border-slate-500 focus:outline-none focus:ring-1 focus:ring-slate-500 ${
                                      isWp ? "font-semibold" : "font-normal"
                                    } min-h-[40px] h-auto overflow-hidden`}
                                  />
                                  <div className="mt-1 flex flex-wrap items-center gap-2 text-xs text-slate-500">
                                    {isWp && (
                                      <>
                                        <button
                                          type="button"
                                          onClick={() => addSub(wpIndex)}
                                          disabled={workPackages[wpIndex].sub.length >= MAX_SUB}
                                          className="rounded border border-slate-200 px-2 py-1 text-slate-600 transition hover:border-slate-300 hover:text-slate-900 disabled:cursor-not-allowed disabled:text-slate-300"
                                        >
                                          +
                                        </button>
                                        <button
                                          type="button"
                                          onClick={() =>
                                            requestDelete(
                                              "sub",
                                              wpIndex,
                                              workPackages[wpIndex].sub.length - 1
                                            )
                                          }
                                          disabled={workPackages[wpIndex].sub.length === 0}
                                          className="rounded border border-slate-200 px-2 py-1 text-slate-600 transition hover:border-slate-300 hover:text-rose-600 disabled:cursor-not-allowed disabled:text-slate-300"
                                        >
                                          –
                                        </button>
                                      </>
                                    )}
                                    {isWp && isPending && (
                                      <span className="ml-1 inline-flex items-center gap-1 text-xs text-rose-600">
                                        Letztes Unterarbeitspaket löschen?
                                        <button
                                          type="button"
                                          onClick={confirmDelete}
                                          className="rounded border border-rose-200 px-2 py-1 text-rose-700"
                                        >
                                          Ja
                                        </button>
                                        <button
                                          type="button"
                                          onClick={cancelDelete}
                                          className="rounded border border-slate-200 px-2 py-1 text-slate-600"
                                        >
                                          Nein
                                        </button>
                                      </span>
                                    )}
                                  </div>
                                </div>
                              </div>
                            </div>

                            {activeCompanyIndexes.map((idx) => (
                              <div
                                key={`pm-${row.type}-${wpIndex}-${subIndex ?? "root"}-${idx}`}
                                className="px-2 py-2"
                              >
                                <input
                                  type="number"
                                  min="0"
                                  step="0.1"
                                  value={values[idx]}
                                  onChange={(event) =>
                                    updatePm(wpIndex, subIndex, idx, event.target.value)
                                  }
                                  className="h-9 min-w-[60px] w-full rounded-md border border-slate-300 px-2 text-sm focus:border-slate-500 focus:outline-none focus:ring-1 focus:ring-slate-500 disabled:bg-slate-100"
                                />
                              </div>
                            ))}

                            <div className="px-4 py-2 text-right text-sm font-semibold text-slate-700">
                              {rowSum.toFixed(2)}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>

                  <div>
                    <div className="sticky top-0 z-30 border-b border-slate-200 bg-slate-100/90 backdrop-blur">
                      <div
                        className={`flex h-full flex-col px-4 py-3 ${getRowHeight({
                          type: "header",
                        })}`}
                      >
                        <div className="flex items-center justify-between text-sm font-semibold text-slate-700">
                          Gantt-Zeitleiste
                          <span className="text-xs font-medium text-slate-500">
                            Monate 1–{durationMonths}
                          </span>
                        </div>
                        <div className="mt-2 flex items-center gap-3">
                          <input
                            type="range"
                            min="0"
                            max={ganttMaxScroll}
                            value={ganttScrollLeft}
                            onChange={handleGanttSliderChange}
                            className="h-2 w-full accent-slate-600"
                          />
                          <span className="text-[11px] font-medium text-slate-500">
                            Scroll
                          </span>
                        </div>
                        <div
                          ref={ganttTimelineRef}
                          className="mt-2 w-full overflow-hidden rounded-md border border-slate-200 bg-white"
                        >
                          <div
                            className="grid text-center text-[11px] font-semibold uppercase text-slate-500"
                            style={monthGridStyle}
                          >
                            {yearSegments.map((segment, index) => (
                              <div
                                key={`year-${segment.year}-${index}`}
                                className="border-r border-slate-200 py-1"
                                style={{ gridColumn: `span ${segment.span}` }}
                              >
                                {segment.year}
                              </div>
                            ))}
                          </div>
                          <div
                            className="gantt-grid border-t border-slate-200 text-[10px] text-slate-500"
                            style={monthGridStyle}
                          >
                            {timeline.map((month, index) => (
                              <div
                                key={`month-${month.year}-${index}`}
                                className="border-r border-slate-200 py-1 text-center"
                              >
                                {month.label}
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>
                    </div>

                    <div
                      ref={ganttScrollRef}
                      onScroll={handleGanttScroll}
                      className="overflow-x-auto"
                    >
                      <div className="w-max divide-y divide-slate-100/70">
                        {rows.map((row, rowIndex) => {
                          const wpIndex = row.wpIndex;
                          const accent =
                            row.type === "summary" || row.type === "wp" || row.type === "sub"
                              ? groupAccentClasses[wpIndex % groupAccentClasses.length]
                              : "";
                          const isGroupStart = row.type === "wp";
                          const groupBorder = isGroupStart
                            ? "border-t border-slate-200"
                            : "border-t border-slate-100/80";
                          const rowKey =
                            row.type === "wp" || row.type === "sub"
                              ? `row-${row.type}-${wpIndex}-${row.subIndex ?? "root"}`
                              : null;
                          return (
                            <div
                              key={`gantt-row-${row.type}-${rowIndex}`}
                              className={`px-4 py-2 ${groupBorder} ${accent} ${getRowTone(
                                row
                              )} ${getRowHeight(row)}`}
                              style={
                                rowKey && rowHeights[rowKey]
                                  ? { height: `${rowHeights[rowKey]}px` }
                                  : undefined
                              }
                            >
                              <div className="relative w-max overflow-hidden rounded border border-slate-200 bg-white">
                                <div className="gantt-grid" style={monthGridStyle}>
                                  {Array.from({ length: durationMonths }, (_, index) => (
                                    <div
                                      key={`cell-${row.type}-${rowIndex}-${index}`}
                                      className="h-6 border-r border-dashed border-slate-200"
                                    />
                                  ))}
                                </div>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div className="mt-10 space-y-8">
                {activeCompanyIndexes.map((companyIndex) => {
                  const companyName =
                    companyNames[companyIndex] || `Unternehmen ${companyIndex + 1}`;
                  const companyEmployees = employeesByCompany[companyIndex] || [];
                  const companyCosts = employeeCostsByCompany[companyIndex] || [];
                  const companyRows = filteredWorkPackageRowsByCompany[companyIndex] || [];
                  const displayCompanyRows = companyRows.length
                    ? companyRows
                    : [
                        {
                          id: `placeholder-${companyIndex}`,
                          number: "–",
                          title: "",
                          pmByCompany: [],
                          isPlaceholder: true,
                        },
                      ];
                  const usedPmByEmployee = usedPmByCompanyEmployeeYear[companyIndex] || [];
                  return (
                    <section
                      key={`company-planning-${companyIndex}`}
                      className="rounded-2xl border border-slate-200 bg-white p-5 shadow-subtle"
                    >
                      <div className="border-b border-slate-200 pb-4">
                        <p className="text-xs font-semibold uppercase tracking-[0.18em] text-slate-500">
                          Unternehmensplanung
                        </p>
                        <h3 className="mt-2 text-xl font-semibold text-slate-850">
                          Unternehmensplanung: {companyName}
                        </h3>
                      </div>

                      <div className="mt-6 space-y-6">
                        <div className="rounded-xl border border-slate-200 bg-white shadow-subtle">
                          <div className="flex flex-wrap items-start justify-between gap-4 border-b border-slate-200 bg-slate-50 px-5 py-4">
                            <div>
                              <h4 className="text-lg font-semibold text-slate-850">
                                Mitarbeiter
                              </h4>
                              <p className="mt-1 text-sm text-slate-600">
                                Mitarbeitende für {companyName} (max. {MAX_EMPLOYEES}).
                              </p>
                            </div>
                            <div className="flex flex-wrap items-center gap-2">
                              <button
                                type="button"
                                onClick={() => addEmployee(companyIndex)}
                                disabled={companyEmployees.length >= MAX_EMPLOYEES}
                                className="inline-flex items-center gap-2 rounded-md bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-subtle transition disabled:cursor-not-allowed disabled:bg-slate-300"
                              >
                                + Mitarbeiter
                              </button>
                              <button
                                type="button"
                                onClick={() => requestEmployeeRemove(companyIndex)}
                                disabled={companyEmployees.length === 0}
                                className="inline-flex items-center gap-2 rounded-md border border-slate-300 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-subtle transition hover:border-slate-400 disabled:cursor-not-allowed disabled:border-slate-200 disabled:text-slate-300"
                              >
                                – Mitarbeiter
                              </button>
                            </div>
                          </div>
                          {pendingEmployeeDelete === companyIndex && (
                            <div className="flex flex-wrap items-center justify-end gap-2 border-b border-slate-200 px-5 py-2 text-xs text-rose-600">
                              Letzten Mitarbeiter wirklich löschen?
                              <button
                                type="button"
                                onClick={confirmEmployeeRemove}
                                className="rounded border border-rose-200 px-2 py-1 text-rose-700"
                              >
                                Ja
                              </button>
                              <button
                                type="button"
                                onClick={cancelEmployeeRemove}
                                className="rounded border border-slate-200 px-2 py-1 text-slate-600"
                              >
                                Nein
                              </button>
                            </div>
                          )}

                          <div className="max-h-[360px] overflow-y-auto">
                            <div className="sticky top-0 z-10 border-b border-slate-200 bg-slate-100/90 backdrop-blur">
                              <div
                                className="grid items-center text-xs font-semibold uppercase text-slate-500"
                                style={{ gridTemplateColumns: employeeGridTemplate }}
                              >
                                <div className="px-4 py-3">Teilzeitfaktor</div>
                                <div className="px-4 py-3">Projekteinsatz %</div>
                                <div className="px-4 py-3">Name</div>
                                <div className="px-4 py-3">Typische Wochenstunden</div>
                                <div className="px-4 py-3">
                                  Tatsächliche Wochenstunden
                                </div>
                                <div className="px-4 py-3">Jahresgehalt</div>
                              </div>
                            </div>

                            <div className="divide-y divide-slate-100">
                              {companyEmployees.map((employee, index) => (
                                <div
                                  key={`company-${companyIndex}-employee-${index}`}
                                  className={`grid items-center h-[56px] bg-white ${
                                    index % 2 === 0 ? "" : "bg-slate-50/60"
                                  }`}
                                  style={{ gridTemplateColumns: employeeGridTemplate }}
                                >
                                  <div className="px-4">
                                    <input
                                      type="number"
                                      min="0"
                                      max="1"
                                      step="0.1"
                                      value={employee.partTimeFactor}
                                      onChange={(event) =>
                                        updateEmployeeNumber(
                                          companyIndex,
                                          index,
                                          "partTimeFactor",
                                          event.target.value,
                                          0,
                                          1
                                        )
                                      }
                                      className="h-9 w-full rounded-md border border-slate-300 px-2 text-sm focus:border-slate-500 focus:outline-none focus:ring-1 focus:ring-slate-500"
                                    />
                                  </div>
                                  <div className="px-4">
                                    <input
                                      type="number"
                                      min="0"
                                      max="100"
                                      step="0.1"
                                      value={employee.projectPercent}
                                      onChange={(event) =>
                                        updateEmployeeNumber(
                                          companyIndex,
                                          index,
                                          "projectPercent",
                                          event.target.value,
                                          0,
                                          100
                                        )
                                      }
                                      className="h-9 w-full rounded-md border border-slate-300 px-2 text-sm focus:border-slate-500 focus:outline-none focus:ring-1 focus:ring-slate-500"
                                    />
                                  </div>
                                  <div className="px-4">
                                    <input
                                      type="text"
                                      value={employee.name}
                                      onChange={(event) =>
                                        updateEmployeeField(
                                          companyIndex,
                                          index,
                                          "name",
                                          event.target.value
                                        )
                                      }
                                      placeholder={`Mitarbeiter ${index + 1}`}
                                      className="h-9 w-full rounded-md border border-slate-300 px-3 text-sm focus:border-slate-500 focus:outline-none focus:ring-1 focus:ring-slate-500"
                                    />
                                  </div>
                                  <div className="px-4">
                                    <input
                                      type="number"
                                      min="0"
                                      step="0.5"
                                      value={employee.weeklyHours}
                                      onChange={(event) =>
                                        updateEmployeeNumber(
                                          companyIndex,
                                          index,
                                          "weeklyHours",
                                          event.target.value,
                                          0
                                        )
                                      }
                                      className="h-9 w-full rounded-md border border-slate-300 px-2 text-sm focus:border-slate-500 focus:outline-none focus:ring-1 focus:ring-slate-500"
                                    />
                                  </div>
                                  <div className="px-4">
                                    <input
                                      type="number"
                                      min="0"
                                      step="0.5"
                                      value={employee.actualHours}
                                      onChange={(event) =>
                                        updateEmployeeNumber(
                                          companyIndex,
                                          index,
                                          "actualHours",
                                          event.target.value,
                                          0
                                        )
                                      }
                                      className="h-9 w-full rounded-md border border-slate-300 px-2 text-sm focus:border-slate-500 focus:outline-none focus:ring-1 focus:ring-slate-500"
                                    />
                                  </div>
                                  <div className="px-4">
                                    <div className="relative">
                                      <input
                                        type="number"
                                        min="0"
                                        step="100"
                                        value={employee.annualSalary}
                                        onChange={(event) =>
                                          updateEmployeeNumber(
                                            companyIndex,
                                            index,
                                            "annualSalary",
                                            event.target.value,
                                            0
                                          )
                                        }
                                        className="h-9 w-full rounded-md border border-slate-300 px-2 pr-7 text-sm focus:border-slate-500 focus:outline-none focus:ring-1 focus:ring-slate-500"
                                      />
                                      <span className="pointer-events-none absolute inset-y-0 right-2 flex items-center text-xs font-semibold text-slate-500">
                                        €
                                      </span>
                                    </div>
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        </div>

                        <div className="rounded-xl border border-slate-200 bg-white shadow-subtle">
                          <div className="border-b border-slate-200 bg-slate-50 px-5 py-4">
                            <h4 className="text-lg font-semibold text-slate-850">
                              Zuordnung Arbeitspakete und Mitarbeitende
                            </h4>
                            <p className="mt-1 text-sm text-slate-600">
                              Zeigt nur Arbeitspakete mit PM &gt; 0 aus der Projektplanung.
                            </p>
                          </div>
                          <div className="max-h-[320px] overflow-auto">
                            <div className="sticky top-0 z-10 border-b border-slate-200 bg-white/95 backdrop-blur">
                              <div className="grid grid-cols-[110px_minmax(240px,1.6fr)_minmax(140px,0.7fr)_minmax(140px,0.7fr)_130px_minmax(150px,0.9fr)] text-xs font-semibold uppercase text-slate-500">
                                <div className="px-4 py-3">WP-Nr.</div>
                                <div className="px-4 py-3">Arbeitspaket</div>
                                <div className="px-4 py-3">Start</div>
                                <div className="px-4 py-3">Ende</div>
                                <div className="px-4 py-3">MA-Nr.</div>
                                <div className="px-4 py-3 text-right">Kosten</div>
                              </div>
                            </div>
                            <div className="divide-y divide-slate-100">
                              {displayCompanyRows.map((row, index) => {
                                const isPlaceholder = row.isPlaceholder;
                                const entry =
                                  companyData[companyIndex]?.tabellenEintraege?.[row.id] || {};
                                const employeeNumber = parseInt(entry.mitarbeiterNummer, 10);
                                const employeeIndex = employeeNumber ? employeeNumber - 1 : null;
                                const pmDemand = isPlaceholder
                                  ? 0
                                  : row.pmByCompany?.[companyIndex] || 0;
                                const costPerPM =
                                  employeeIndex !== null
                                    ? companyCosts[employeeIndex]?.costPerPM || 0
                                    : 0;
                                const costValue =
                                  !isPlaceholder && employeeIndex !== null && pmDemand > 0
                                    ? formatCurrency(pmDemand * costPerPM)
                                    : "–";
                                return (
                                  <div
                                    key={`company-${companyIndex}-row-${row.id}`}
                                    className={`grid grid-cols-[110px_minmax(240px,1.6fr)_minmax(140px,0.7fr)_minmax(140px,0.7fr)_130px_minmax(150px,0.9fr)] items-center ${
                                      index % 2 === 0 ? "bg-white" : "bg-slate-50/60"
                                    }`}
                                  >
                                    <div className="px-4 py-2 text-sm font-semibold text-slate-700">
                                      {row.number}
                                    </div>
                                    <div className="px-4 py-2">
                                      <input
                                        type="text"
                                        readOnly
                                        value={row.title || ""}
                                        placeholder="Arbeitspaket-Titel"
                                        className="h-9 w-full rounded-md border border-slate-200 bg-slate-100 px-3 text-sm text-slate-700"
                                      />
                                    </div>
                                    <div className="px-4 py-2">
                                      <input
                                        type="text"
                                        value={isPlaceholder ? "" : entry.start || ""}
                                        onChange={(event) =>
                                          updateCompanyTableEntry(
                                            companyIndex,
                                            row.id,
                                            "start",
                                            event.target.value
                                          )
                                        }
                                        disabled={isPlaceholder}
                                        placeholder="MM.YYYY"
                                        className="h-9 w-full rounded-md border border-slate-300 px-3 text-sm text-slate-700 focus:border-slate-500 focus:outline-none focus:ring-1 focus:ring-slate-500"
                                      />
                                    </div>
                                    <div className="px-4 py-2">
                                      <input
                                        type="text"
                                        value={isPlaceholder ? "" : entry.ende || ""}
                                        onChange={(event) =>
                                          updateCompanyTableEntry(
                                            companyIndex,
                                            row.id,
                                            "ende",
                                            event.target.value
                                          )
                                        }
                                        disabled={isPlaceholder}
                                        placeholder="MM.YYYY"
                                        className="h-9 w-full rounded-md border border-slate-300 px-3 text-sm text-slate-700 focus:border-slate-500 focus:outline-none focus:ring-1 focus:ring-slate-500"
                                      />
                                    </div>
                                    <div className="px-4 py-2">
                                      <input
                                        type="number"
                                        min="1"
                                        max={companyEmployees.length || 1}
                                        step="1"
                                        value={isPlaceholder ? "" : entry.mitarbeiterNummer || ""}
                                        onChange={(event) =>
                                          updateCompanyTableEntry(
                                            companyIndex,
                                            row.id,
                                            "mitarbeiterNummer",
                                            event.target.value
                                          )
                                        }
                                        disabled={isPlaceholder}
                                        placeholder="MA-Nr."
                                        className="h-9 w-full rounded-md border border-slate-300 px-3 text-sm text-slate-700 focus:border-slate-500 focus:outline-none focus:ring-1 focus:ring-slate-500"
                                      />
                                    </div>
                                    <div className="px-4 py-2 text-right text-sm font-semibold text-slate-700">
                                      {costValue}
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                        </div>

                        <div className="rounded-xl border border-slate-200 bg-white shadow-subtle">
                          <div className="border-b border-slate-200 bg-slate-50 px-5 py-4">
                            <h4 className="text-lg font-semibold text-slate-850">
                              Mitarbeiter-Auslastung
                            </h4>
                            <p className="mt-1 text-sm text-slate-600">
                              Pro Kalenderjahr: PM (oben) und prozentuale Auslastung.
                            </p>
                          </div>
                          <div className="overflow-auto">
                            <div
                              className="grid min-w-[480px] items-center border-b border-slate-200 bg-white text-xs font-semibold uppercase text-slate-500"
                              style={{
                                gridTemplateColumns: `140px repeat(${projectYears.length}, minmax(160px, 1fr))`,
                              }}
                            >
                              <div className="px-4 py-3">MA-Nr.</div>
                              {projectYears.map((year) => (
                                <div key={`util-head-${companyIndex}-${year}`} className="px-4 py-3">
                                  Auslastung ({year})
                                </div>
                              ))}
                            </div>
                            <div className="divide-y divide-slate-100">
                              {companyEmployees.map((employee, employeeIndex) => (
                                <div
                                  key={`util-row-${companyIndex}-${employeeIndex}`}
                                  className={`grid items-center text-sm ${
                                    employeeIndex % 2 === 0 ? "bg-white" : "bg-slate-50/60"
                                  }`}
                                  style={{
                                    gridTemplateColumns: `140px repeat(${projectYears.length}, minmax(160px, 1fr))`,
                                  }}
                                >
                                  <div className="px-4 py-3 font-semibold text-slate-700">
                                    {employeeIndex + 1}
                                  </div>
                                  {projectYears.map((year) => {
                                    const capPM = yearCaps[year] || 0;
                                    const usedPM =
                                      usedPmByEmployee?.[employeeIndex]?.[year] || 0;
                                    const utilization =
                                      capPM > 0 ? (usedPM / capPM) * 100 : 0;
                                    return (
                                      <div
                                        key={`util-${companyIndex}-${employeeIndex}-${year}`}
                                        className="px-4 py-3"
                                      >
                                        <div className="flex flex-col text-xs">
                                          <span className="font-semibold text-slate-700">
                                            {usedPM.toFixed(2)} PM
                                          </span>
                                          <span className="text-slate-500">
                                            {utilization.toFixed(0)}%
                                          </span>
                                        </div>
                                      </div>
                                    );
                                  })}
                                </div>
                              ))}
                            </div>
                          </div>
                        </div>
                      </div>
                    </section>
                  );
                })}
              </div>
            </main>
          </div>
        );
      };

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
